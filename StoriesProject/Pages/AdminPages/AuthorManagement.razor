@page "/admin/author_management"
@using StoriesProject.Services;
@using StoriesProject.Model.ViewModel.Accountant
@using StoriesProject.Model.BaseEntity;

@inject IAccoutantsService _accoutantsService;
@inject IJSRuntime _js;

<body>
    <div class="wrapper">
        <AdminSidebar />
        <div class="main">
            <nav class="navbar navbar-expand px-4 py-3">
                <form action="#" class="d-none d-sm-inline-block">
                </form>
                <div class="navbar-collapse collapse">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item dropdown">
                            <a href="#" data-bs-toggle="dropdown" class="nav-icon pe-md-0">
                                <img src="/account.png" class="avatar img-fluid" alt="">
                            </a>
                            <div class="dropdown-menu dropdown-menu-end rounded">
                            </div>
                        </li>
                    </ul>
                </div>
            </nav>
            <main class="content px-3 py-4">
                <div class="container-fluid">
                    <div class="mb-3">
                        <h3 class="fw-bold fs-4 mb-5">Author Management</h3>

                        <ul class="nav nav-tabs mb-5" id="myTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class=@(selectedTab==1 ? "nav-link active": "nav-link") id="active-tab" data-bs-toggle="tab" data-bs-target="#active"
                                        type="button" role="tab" aria-controls="active" aria-selected=@(selectedTab==1 ? "true": "false") @onclick="() => SetSelectedTab(1)">
                                    Đang hoạt động
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class=@(selectedTab==2 ? "nav-link active": "nav-link") id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button"
                                        role="tab" aria-controls="pending" aria-selected=@(selectedTab==2 ? "true": "false") @onclick="() => SetSelectedTab(2)">
                                    Chờ xét duyệt
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class=@(selectedTab==3 ? "nav-link active": "nav-link") id="blocked-tab" data-bs-toggle="tab" data-bs-target="#blocked" type="button"
                                        role="tab" aria-controls="blocked" aria-selected=@(selectedTab==3 ? "true": "false") @onclick="() => SetSelectedTab(3)">
                                    Đang bị chặn
                                </button>
                            </li>
                        </ul>


                        <div class="tab-content" id="myTabsContent">
                            @if (selectedTab == 1)
                            {
                                <div class="tab-pane fade show active" id="active" role="tabpanel" aria-labelledby="active-tab">
                                    <h3 class="fw-bold fs-5 mb-4" style="color: #1f6b0a;">Đang hoạt động</h3>
                                    <div style="display: flex;align-items: center;" class="mb-5">
                                        <strong>Thống kê theo: </strong>
                                        <div class="dropdown">
                                            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton"
                                                    data-bs-toggle="dropdown" aria-expanded="false" style="width: 200px; margin-left: 10px;">
                                                All of time
                                            </button>
                                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                                <li><a class="dropdown-item" href="#">Theo tháng</a></li>
                                                <li><a class="dropdown-item" href="#">Theo tuần</a></li>
                                                <li><a class="dropdown-item" href="#">Theo năm</a></li>
                                                <li><a class="dropdown-item" href="#">All of time</a></li>
                                            </ul>
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-12">
                                            <table class="table table-striped" style="width: 95%;">
                                                <thead>
                                                    <tr class="highlight">
                                                        <th scope="col">#</th>
                                                        <th scope="col">Họ tên</th>
                                                        <th scope="col">Số tác phẩm</th>
                                                        <th scope="col">Tổng số đã bán (bản)</th>
                                                        <th scope="col" style="width: 400px;">Doanh số (vnd)</th>
                                                        <th scope="col">Chi tiết</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <th scope="row">1</th>
                                                        <td>Trần Vinh</td>
                                                        <td>50</td>
                                                        <td>200</td>
                                                        <td>2,000,000 </td>
                                                        <td>
                                                            <a href="#">
                                                                <i class="lni lni-eye"></i>
                                                                Xem
                                                            </a>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <th scope="row">2</th>
                                                        <td>Trần Vinh</td>
                                                        <td>50</td>
                                                        <td>200</td>
                                                        <td>2,000,000 </td>
                                                        <td>
                                                            <a href="#">
                                                                <i class="lni lni-eye"></i>
                                                                Xem
                                                            </a>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <th scope="row">3</th>
                                                        <td>Trần Vinh</td>
                                                        <td>50</td>
                                                        <td>200</td>
                                                        <td>2,000,000 </td>
                                                        <td>
                                                            <a href="#">
                                                                <i class="lni lni-eye"></i>
                                                                Xem
                                                            </a>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            }

                            @if(selectedTab == 2)
                            {
                                <div class="tab-pane fade show active" id="pending" role="tabpanel" aria-labelledby="pending-tab">
                                    <h3 class="fw-bold fs-5 mb-5" style="color: rgb(53, 70, 145);">Chờ xét duyệt</h3>
                                    <div class="row">
                                        <div class="col-12">
                                            <table class="table table-striped" style="width: 95%;">
                                                <thead>
                                                    <tr class="highlight">
                                                        <th scope="col">#</th>
                                                        <th scope="col">Họ tên</th>
                                                        @*<th scope="col">Username</th>*@
                                                        <th scope="col">Email</th>
                                                        <th scope="col">Ngày đăng ký</th>
                                                        <th scope="col">Action</th>

                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @if (lstRegisterAccountants != null && lstRegisterAccountants.Count() > 0)
                                                    {
                                                        @for (int i = 0; i < lstRegisterAccountants.Count; i++)
                                                        {
                                                            var item = lstRegisterAccountants[i];
                                                            int currentIndex = i + 1;
                                                            <tr>
                                                                <th scope="row">@currentIndex</th>
                                                                <td>@item.Name</td>
                                                                @*<td>@item.UserName</td>*@
                                                                <td>@item.Email</td>
                                                                <td>@item.CreatedDate</td>
                                                                <td>
                                                                    <button type="button" class="btn btn-success"
                                                                            style="background-color: #1f6b0a;"
                                                                        @onclick="() => ApprovedAccountant(item.AuthorRegisterId)"
                                                                    >
                                                                        Duyệt
                                                                    </button>
                                                                    <button type="button" class="btn btn-danger" style="background-color: #9e2828;"
                                                                        @onclick="() => DeniedAccountant(item.AuthorRegisterId)"
                                                                    >
                                                                        Từ
                                                                        chối
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        }
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                            }
                            @if(selectedTab == 3)
                            {
                                <div class="tab-pane fade show active" id="blocked" role="tabpanel" aria-labelledby="blocked-tab">
                                    <h3 class="fw-bold fs-5 mb-4" style="color: #9e2828;">Đang bị chặn</h3>
                                    <div style="display: flex;align-items: center;" class="mb-5">
                                        <strong>Thống kê theo: </strong>
                                        <div class="dropdown">
                                            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton"
                                                    data-bs-toggle="dropdown" aria-expanded="false" style="width: 200px; margin-left: 10px;">
                                                All of time
                                            </button>
                                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                                <li><a class="dropdown-item" href="#">Theo tháng</a></li>
                                                <li><a class="dropdown-item" href="#">Theo tuần</a></li>
                                                <li><a class="dropdown-item" href="#">Theo năm</a></li>
                                                <li><a class="dropdown-item" href="#">All of time</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <table class="table table-striped" style="width: 95%;">
                                                <thead>
                                                    <tr class="highlight">
                                                        <th scope="col">#</th>
                                                        <th scope="col">Họ tên</th>
                                                        <th scope="col">Username</th>
                                                        <th scope="col">Email</th>
                                                        <th scope="col">Trạng thái</th>
                                                        <th scope="col">Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @if (lstLockedAccountant != null && lstLockedAccountant.Count() > 0)
                                                    {
                                                        @for (int i = 0; i < lstLockedAccountant.Count; i++)
                                                        {
                                                            var item = lstLockedAccountant[i];
                                                            int currentIndex = i + 1;
                                                            var state = item.IsLocked ? "Bị chặn" : "Hoạt động";
                                                            <tr>
                                                                <th scope="row">@currentIndex</th>
                                                                <td>@item.Name</td>
                                                                <td>@item.UserName</td>
                                                                <td>@item.Email</td>
                                                                <td>@state</td>
                                                                <td>
                                                                    @if (item.IsLocked)
                                                                    {
                                                                        <button type="button" class="btn btn-success"
                                                                                style="background-color: #1f6b0a;"
                                                                                @onclick="() => UpdateLockedAccountant(item.Id, false)">
                                                                            Bỏ chặn
                                                                        </button>
                                                                    } else
                                                                    {
                                                                        <button type="button" class="btn btn-danger" style="background-color: #9e2828;"
                                                                                @onclick="() => UpdateLockedAccountant(item.Id, true)">
                                                                            Chặn
                                                                        </button>
                                                                    }
                                                                    
                                                                </td>
                                                            </tr>
                                                        }
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                            }
                        </div>
                    </div>
                </div>
            </main>
            <footer class="footer">
                <div class="container-fluid">
                    <div class="row text-body-secondary">
                        <div class="col-6 text-start ">
                            <a class="text-body-secondary" href=" #">
                                <strong>ComicHub</strong>
                            </a>
                        </div>
                        <div class="col-6 text-end text-body-secondary d-none d-md-block">
                            <ul class="list-inline mb-0">
                                <li class="list-inline-item">
                                    <a class="text-body-secondary" href="#">Contact</a>
                                </li>
                                <li class="list-inline-item">
                                    <a class="text-body-secondary" href="#">About Us</a>
                                </li>
                                <li class="list-inline-item">
                                    <a class="text-body-secondary" href="#">Terms & Conditions</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </footer> 
        </div>
    </div>
    @*  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
    crossorigin="anonymous"></script>
    <script src="script.js"></script>*@
</body>

<script src="js/authormanagement.js" suppress-error="BL9992"></script>

@code {
    private int selectedTab = 1;
    private void SetSelectedTab(int tab)
    {
        selectedTab = tab;
    }

    private List<AuthorRegister> lstRegisterAccountants { get; set; }
    private List<Accountant> lstLockedAccountant { get; set; } // danh sách user tab đang bị chặn

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            lstRegisterAccountants = await _accoutantsService.GetRegisterAccountantsByRole();
            lstLockedAccountant = await _accoutantsService.GetAllAccountants();
        }
    }

    private async Task ApprovedAccountant(Guid regiserId)
    {
        var res = await _accoutantsService.ApprovedAccountant(regiserId);
        if (res != null && res.IsSuccess)
        {
            await _js.InvokeVoidAsync("showToast", res?.Data);
            lstRegisterAccountants = await _accoutantsService.GetRegisterAccountantsByRole();
            StateHasChanged();

        }
        else
        {
            await _js.InvokeVoidAsync("showToast", res?.Message);
        }
    }

    private async Task DeniedAccountant(Guid regiserId)
    {
        var res = await _accoutantsService.DeniedAccountant(regiserId);
        if (res != null && res.IsSuccess)
        {
            await _js.InvokeVoidAsync("showToast", res?.Data);
            lstRegisterAccountants = await _accoutantsService.GetRegisterAccountantsByRole();
            StateHasChanged();
        }
        else
        {
            await _js.InvokeVoidAsync("showToast", res?.Message);
        }
    }

    private async Task UpdateLockedAccountant(Guid userId, bool isLocked)
    {
        var param = new LockedAccountantParam()
            {
                AccountantId = userId,
                IsLocked = isLocked
            };

        var res = await _accoutantsService.UpdateLockedAccountant(param);
        if (res != null && res.IsSuccess)
        {
            await _js.InvokeVoidAsync("showToast", res?.Data);
            lstLockedAccountant = await _accoutantsService.GetAllAccountants();
            StateHasChanged();
        }
        else
        {
            await _js.InvokeVoidAsync("showToast", res?.Message);
        }
    }
}
